# ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Backup ‡πÅ‡∏•‡∏∞ Dependency Resolution

**‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:** 2025-12-03  
**Workflow:** `smartspec_generate_spec.md`  
**‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:** ‚úÖ FIXED

---

## ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏û‡∏ö

### 1. Backup File ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á ‚ùå

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£:**
- ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå backup ‡πÄ‡∏°‡∏∑‡πà‡∏≠ regenerate SPEC
- spec.md ‡∏ñ‡∏π‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
- ‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•

**‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏:**
- Section 13.5.1 ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á documentation/example code
- ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡πá‡∏ô actionable instruction ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI
- AI ‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á execute backup ‡∏à‡∏£‡∏¥‡∏á‡πÜ

### 2. Related Specs ‡πÑ‡∏°‡πà‡∏°‡∏µ Path ‡πÅ‡∏•‡∏∞ Repo (‡∏™‡∏á‡∏™‡∏±‡∏¢‡∏ß‡πà‡∏≤‡∏´‡∏≤‡∏¢‡πÑ‡∏õ)

**‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô:**
- Related Specs ‡πÑ‡∏°‡πà‡∏°‡∏µ path ‡πÅ‡∏•‡∏∞ repo
- ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°

**‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:**
- ‚úÖ **‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤** - Related Specs ‡∏°‡∏µ path ‡πÅ‡∏•‡∏∞ repo ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡πâ‡∏ß
- ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå spec.md ‡∏ó‡∏µ‡πà user ‡πÅ‡∏ô‡∏ö‡∏°‡∏≤ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î 3401-3418)
- Dependency resolution ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

---

## ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

### 1. Backup Mechanism ‚úÖ

**‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:** Section 13.5.1

**‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:**

#### Before (‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô):
```markdown
#### 13.5.1 Backup Existing SPEC (if exists)

**1. Check if backup needed:**
```typescript
const specPath = path.join(specDir, 'spec.md');
const shouldBackup = fs.existsSync(specPath) && !flags.noBackup;
```
```

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤:**
- ‡πÄ‡∏õ‡πá‡∏ô example code ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà instruction
- AI ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á execute ‡∏à‡∏£‡∏¥‡∏á
- ‡πÑ‡∏°‡πà‡∏°‡∏µ step-by-step actionable commands

---

#### After (‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞ actionable):
```markdown
#### 13.5.1 Backup Existing SPEC (MANDATORY - MUST EXECUTE)

üö® **CRITICAL: This step MUST be executed before writing new spec.md** üö®

**INSTRUCTION FOR AI:**
You MUST perform the following backup steps using shell commands or file operations:

**Step 1: Check if spec.md exists**

Use `file` tool or `shell` tool to check:
```bash
test -f spec.md && echo "EXISTS" || echo "NOT_EXISTS"
```

If spec.md EXISTS, proceed to Step 2.
If NOT_EXISTS, skip to section 13.5.2.

**Step 2: Create backup directory**

MUST execute:
```bash
mkdir -p .smartspec/backups
```

**Step 3: Generate backup filename with timestamp**

Format: `spec.backup-YYYYMMDD-HHmmss.md`

Generate timestamp:
```bash
TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
BACKUP_FILE="spec.backup-${TIMESTAMP}.md"
```

**Step 4: Copy spec.md to backup**

MUST execute:
```bash
cp spec.md ".smartspec/backups/${BACKUP_FILE}"
echo "üíæ Backup created: ${BACKUP_FILE}"
```

OR using `file` tool:
1. Read spec.md content
2. Write to .smartspec/backups/spec.backup-{timestamp}.md

**Step 5: Verify backup was created**

MUST verify:
```bash
test -f ".smartspec/backups/${BACKUP_FILE}" && echo "‚úÖ Backup verified" || echo "‚ùå Backup FAILED"
```

If backup FAILED, STOP and report error. DO NOT proceed to write new spec.md.

**‚ö†Ô∏è IMPORTANT REMINDERS:**

1. ‚úÖ ALWAYS backup before writing new spec.md
2. ‚úÖ VERIFY backup was created successfully
3. ‚úÖ DO NOT proceed if backup fails
4. ‚úÖ Use actual shell commands or file operations
5. ‚úÖ Show backup filename in output
6. ‚ùå NEVER skip backup unless --no-backup flag provided
```

**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**
- ‚úÖ AI ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á execute backup
- ‚úÖ ‡∏°‡∏µ step-by-step commands ‡∏ó‡∏µ‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‚úÖ ‡∏°‡∏µ verification step
- ‚úÖ ‡∏°‡∏µ error handling
- ‚úÖ ‡∏°‡∏µ reminders ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç

---

### 2. Dependency Resolution Enhancement ‚úÖ

**‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á:** Section 13.1.1

**‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á:**

#### Before (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏û‡∏≠):
```markdown
### 13.1.1 Resolve Spec Dependencies (NEW)

If the SPEC includes dependencies (Related Specs section):

1. **Extract dependency IDs** from user input or existing SPEC
2. **Look up each dependency** in SPEC_INDEX.json
3. **Format each dependency** as:
   - **{spec_id}** - {description} - Spec Path: "{path}/spec.md" Repo: {repo}
```

---

#### After (‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÅ‡∏•‡∏∞ mandatory):
```markdown
### 13.1.1 Resolve Spec Dependencies (MANDATORY)

üö® **CRITICAL: Dependencies MUST include path and repo information** üö®

**INSTRUCTION FOR AI:**
When generating Related Specs section, you MUST follow these steps:

**Step 1: Check if SPEC_INDEX.json exists**

Use `file` tool to check:
```bash
test -f .smartspec/SPEC_INDEX.json && echo "EXISTS" || echo "NOT_EXISTS"
```

**Step 2: Load SPEC_INDEX.json (if exists)**

If EXISTS:
1. Read .smartspec/SPEC_INDEX.json using `file` tool
2. Parse JSON structure: { "specs": [{ "id": "...", "title": "...", "path": "...", "repo": "..." }] }
3. Store in memory for lookup

**Step 3: Extract dependency IDs**

From user input or existing SPEC, extract:
- Core dependencies (e.g., spec-core-001-authentication)
- Feature specs (e.g., spec-002-user-management)

**Step 4: Look up each dependency in SPEC_INDEX.json**

For each dependency ID:
```javascript
const spec = SPEC_INDEX.specs.find(s => s.id === dependencyId);

if (spec) {
  return `- **${spec.id}** - ${spec.title} - Spec Path: "${spec.path}/spec.md" Repo: ${spec.repo}`;
} else {
  return `- **${dependencyId}** - [NOT FOUND IN SPEC_INDEX] - Spec Path: "N/A" Repo: unknown`;
}
```

**Step 5: Format each dependency (MANDATORY FORMAT)**

**‚úÖ CORRECT FORMAT (with path and repo):**
- **spec-core-001-authentication** - User authentication for financial operations - Spec Path: "specs/core/spec-core-001-authentication/spec.md" Repo: private

**‚ùå WRONG FORMAT (missing path and repo):**
- **spec-core-001-authentication** - User authentication for financial operations

**‚ö†Ô∏è IMPORTANT REMINDERS:**

1. ‚úÖ ALWAYS try to load SPEC_INDEX.json first
2. ‚úÖ ALWAYS include "Spec Path" and "Repo" in dependency format
3. ‚úÖ Use EXACT format: `- **{id}** - {description} - Spec Path: "{path}/spec.md" Repo: {repo}`
4. ‚ùå NEVER output dependencies without path/repo unless SPEC_INDEX.json doesn't exist
```

**‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:**
- ‚úÖ ‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥‡∏ß‡πà‡∏≤ MANDATORY
- ‚úÖ ‡πÅ‡∏™‡∏î‡∏á CORRECT vs WRONG format ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
- ‚úÖ ‡∏°‡∏µ step-by-step instructions
- ‚úÖ ‡∏°‡∏µ error handling
- ‚úÖ ‡∏°‡∏µ reminders ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥

---

## ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç

**‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** 1 file
- `.kilocode/workflows/smartspec_generate_spec.md`

**‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô:**
- Backup section: ~100 lines (rewritten)
- Dependency section: ~80 lines (enhanced)

**‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:** 2 sections
1. Section 13.5.1 - Backup Mechanism (REWRITTEN)
2. Section 13.1.1 - Dependency Resolution (ENHANCED)

---

## ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏Ñ‡∏≤‡∏î‡∏´‡∏ß‡∏±‡∏á

### ‡πÄ‡∏°‡∏∑‡πà‡∏≠ AI ‡πÉ‡∏ä‡πâ Workflow ‡∏ô‡∏µ‡πâ

**1. Backup Behavior:**
```bash
# AI will execute:
mkdir -p .smartspec/backups
TIMESTAMP=$(date +"%Y%m%d-%H%M%S")
cp spec.md ".smartspec/backups/spec.backup-${TIMESTAMP}.md"

# Output:
üíæ Backup created: spec.backup-20251203-143022.md
‚úÖ Backup verified
```

**2. Dependency Resolution Behavior:**
```markdown
## 8. Related Specs

### Core Dependencies
- **spec-core-001-authentication** - User authentication for financial operations - Spec Path: "specs/core/spec-core-001-authentication/spec.md" Repo: private
- **spec-core-002-authorization** - RBAC for admin financial operations - Spec Path: "specs/core/spec-core-002-authorization/spec.md" Repo: private

### Feature Specs
- **spec-002-user-management** - User profile and account management - Spec Path: "specs/feature/spec-002-user-management/spec.md" Repo: public
```

**3. File Structure:**
```
specs/feature/spec-004-financial-system/
‚îú‚îÄ‚îÄ spec.md (current)
‚îî‚îÄ‚îÄ .smartspec/
    ‚îú‚îÄ‚îÄ SPEC_INDEX.json
    ‚îî‚îÄ‚îÄ backups/
        ‚îú‚îÄ‚îÄ spec.backup-20251203-143022.md (newest)
        ‚îú‚îÄ‚îÄ spec.backup-20251203-120530.md
        ‚îî‚îÄ‚îÄ spec.backup-20251202-165412.md (oldest kept, max 10)
```

---

## ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥

### Test 1: Backup Creation
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á SPEC ‡πÉ‡∏´‡∏°‡πà
2. Regenerate SPEC
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ backup ‡πÉ‡∏ô `.smartspec/backups/`
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backup ‡∏°‡∏µ timestamp ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
5. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ backup content ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö spec.md ‡πÄ‡∏î‡∏¥‡∏°

### Test 2: Dependency Resolution
1. ‡∏™‡∏£‡πâ‡∏≤‡∏á SPEC_INDEX.json
2. Generate SPEC ‡∏Å‡∏±‡∏ö dependencies
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Related Specs ‡∏°‡∏µ path ‡πÅ‡∏•‡∏∞ repo
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ format ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

### Test 3: Fallback Mode
1. ‡∏•‡∏ö SPEC_INDEX.json
2. Generate SPEC ‡∏Å‡∏±‡∏ö dependencies
3. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÅ‡∏™‡∏î‡∏á warning
4. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ dependencies ‡πÑ‡∏°‡πà‡∏°‡∏µ path/repo (fallback)

---

## ‡∏™‡∏£‡∏∏‡∏õ

**‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:**
1. ‚úÖ Backup mechanism ‡πÑ‡∏°‡πà‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‚Üí ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏õ‡πá‡∏ô actionable instructions
2. ‚úÖ Dependency resolution ‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏° mandatory reminders

**‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏´‡∏•‡∏±‡∏Å:**
1. ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏à‡∏≤‡∏Å example code ‡πÄ‡∏õ‡πá‡∏ô step-by-step commands
2. ‡πÄ‡∏û‡∏¥‡πà‡∏° üö® CRITICAL ‡πÅ‡∏•‡∏∞ MANDATORY markers
3. ‡πÄ‡∏û‡∏¥‡πà‡∏° ‚úÖ/‚ùå CORRECT/WRONG format examples
4. ‡πÄ‡∏û‡∏¥‡πà‡∏° verification steps
5. ‡πÄ‡∏û‡∏¥‡πà‡∏° error handling
6. ‡πÄ‡∏û‡∏¥‡πà‡∏° reminders ‡∏ó‡∏µ‡πà‡πÄ‡∏ô‡πâ‡∏ô‡∏¢‡πâ‡∏≥

**‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:**
- AI ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á execute backup ‡∏à‡∏£‡∏¥‡∏á
- AI ‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡∏ß‡πà‡∏≤ dependencies ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ path/repo
- ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Ç‡∏≠‡∏á SPEC

---

**Reviewed by:** SmartSpec Team  
**Date:** 2025-12-03  
**Status:** ‚úÖ READY FOR PRODUCTION
