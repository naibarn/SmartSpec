# SmartSpec Workflow: Data Migration Generator

**Workflow:** `/smartspec_data_migration_generator`  
**Version:** 6.1.0

## 1. Overview

The Data Migration Generator is a powerful workflow that automates the creation of database migration scripts (e.g., SQL `ALTER TABLE`). It uses the output from the `/smartspec_data_model_validator` to identify discrepancies between your defined data model (`spec.md`) and the current database schema, then generates the necessary scripts to resolve them.

This workflow streamlines database schema changes, reduces manual errors, and ensures your database is always synchronized with your application's data model.

## 2. Key Features

- **Automated Script Generation:** Creates SQL migration scripts based on validation reports.
- **Idempotent and Re-runnable:** Safely re-run the workflow without causing unintended side effects.
- **Framework-Aware:** Designed to integrate with popular migration tools like Flyway and Liquibase by generating standard SQL files.
- **Governed Writes:** Generates scripts in a reports directory for review and requires the `--apply` flag to place them in the official migration path.
- **Safety First:** Operates without direct database connections, relying solely on static analysis of the validation report.

## 3. How It Works

1.  **Consumes Report:** Takes the `summary.json` from a `/smartspec_data_model_validator` run as its primary input.
2.  **Identifies Deltas:** Parses the report to find schema differences, such as missing tables, new columns, or modified data types.
3.  **Generates SQL:** For each delta, it constructs the appropriate SQL DDL statement (e.g., `CREATE TABLE`, `ALTER TABLE ADD COLUMN`).
4.  **Creates Migration File:** Bundles the SQL statements into a versioned migration file (e.g., `V1__add_user_email.sql`).
5.  **Writes to Output:** Places the generated file in a reports directory for review. If `--apply` is used, it moves the file to the project's official database migrations folder.

## 4. Usage

This workflow is typically run after the Data Model Validator.

### Step 1: Run the Validator

```bash
/smartspec_data_model_validator \
  --spec specs/my-feature/spec.md \
  --db-schema-path path/to/current_schema.json \
  --out .spec/reports/data-model-validation/run-123
```

### Step 2: Generate the Migration Script

```bash
/smartspec_data_migration_generator \
  --validation-report .spec/reports/data-model-validation/run-123/summary.json \
  --apply
```

## 5. Input and Flags

- **`--validation-report <path>` (Required):** Path to the `summary.json` file from a `/smartspec_data_model_validator` run.
- **`--apply` (Optional):** Moves the generated migration script to the official migrations directory for execution by tools like Flyway.
- **`--dialect <PostgreSQL|MySQL>` (Optional):** Specifies the SQL dialect. Defaults to `PostgreSQL`.
- **`--out <path>` (Optional):** Overrides the default output directory.

## 6. Output: SQL Migration File

The workflow generates a standard, versioned SQL migration file. The filename is generated based on the changes.

**Example Output File:** `V202401011200__add_last_login_to_users.sql`

```sql
-- Generated by SmartSpec Data Migration Generator
-- Version: 6.1.0
-- Based on report: run-123

ALTER TABLE users ADD COLUMN last_login_at TIMESTAMP WITH TIME ZONE;
```

## 7. Use Cases

- **Automate Schema Changes:** When you add a new field to a data model in `spec.md`, this workflow automatically creates the `ALTER TABLE` script.
- **Ensure Consistency:** Keep your database schema perfectly aligned with your application's data model definition.
- **Reduce Human Error:** Eliminate typos and mistakes common in manually written migration scripts.
