# /smartspec_data_migration_generator Manual (v6.0, English)

## Overview

The `/smartspec_data_migration_generator` workflow (Version 6.1.0) is designed to automate the process of creating draft database migration scripts. It consumes the validation report generated by `/smartspec_data_model_validator` and translates the identified discrepancies (e.g., missing tables, missing columns) into executable Data Definition Language (DDL) statements.

**Purpose:** To accelerate the implementation phase by automatically drafting necessary database changes required to bring the current database schema in line with the SmartSpec definition.

**Key Features:**

1.  **Tool Agnostic Output:** Supports output formatting for popular migration tools like Flyway and Liquibase, or raw SQL.
2.  **Safety First:** Implements a strict governance model, requiring the `--apply` flag for writing scripts and the `--allow-destructive` flag for generating scripts containing potentially dangerous operations (`DROP TABLE`, `DROP COLUMN`).
3.  **Preview Mode:** By default, it runs in preview mode, generating a detailed report of the proposed changes without modifying the filesystem outside of the safe report directory.

---

## Usage

### CLI (Command Line Interface)

The primary method for invoking the migration generator.

```bash
/smartspec_data_migration_generator \
  --report <path/to/validation-report.json> \
  --migration-tool <flyway|liquibase|raw-sql> \
  --output-dir <path/to/migrations> \
  [--allow-destructive] \
  [--apply]
```

### Kilo Code

The workflow can be executed within a Kilo environment, typically for integration into CI/CD pipelines or automated development scripts.

```bash
/smartspec_data_migration_generator.md \
  --report .spec/reports/data-model-validation/<run-id>/summary.json \
  --migration-tool flyway \
  --output-dir db/migrations
```

---

## Use Cases

### Use Case 1: Generating a Non-Destructive Migration (Preview)

**Scenario:** A recent spec change introduced a new `users.email` column and a new `settings` table. The developer wants to see the proposed Flyway script before committing to the change.

**Validation Report Summary (simulated):**
The validation report shows `missing_column: users.email` and `missing_table: settings`.

**CLI Command (Preview Mode):**

```bash
/smartspec_data_migration_generator \
  --report .spec/reports/validator/run_123/summary.json \
  --migration-tool flyway \
  --output-dir db/migrations 
# Note: --apply is omitted, resulting in a preview run.
```

**Expected Result:**

1.  Exit Code: `0` (Success/Preview Generated).
2.  No file is written to `db/migrations`.
3.  A detailed report is generated at `.spec/reports/data-migration-generator/<run-id>/report.md`, containing the full content of the proposed migration script (e.g., `ALTER TABLE users ADD COLUMN email VARCHAR(255); CREATE TABLE settings (...);`).
4.  `summary.json` indicates `applied: false`.

### Use Case 2: Applying a Destructive Migration

**Scenario:** The spec was updated to remove an obsolete `legacy_data` table and the `users.phone_number` column. The developer understands the risk and needs to generate the final SQL script for review and execution.

**Validation Report Summary (simulated):**
The validation report shows `extra_table: legacy_data` and `extra_column: users.phone_number`.

**CLI Command (Apply Mode with Destructive Flag):**

```bash
/smartspec_data_migration_generator \
  --report .spec/reports/validator/run_124/summary.json \
  --migration-tool raw-sql \
  --output-dir sql/migrations \
  --allow-destructive \
  --apply
```

**Expected Result:**

1.  Exit Code: `0`.
2.  A new file is created in `sql/migrations` (e.g., `sql/migrations/V20251213103000__spec_update.sql`).
3.  The file content includes:
    ```sql
    -- WARNING: DESTRUCTIVE OPERATION
    DROP TABLE legacy_data;
    -- WARNING: DESTRUCTIVE OPERATION
    ALTER TABLE users DROP COLUMN phone_number;
    ```
4.  `summary.json` indicates `applied: true` and `destructive_operations_found: true`.

### Use Case 3: Failure due to Missing Destructive Flag

**Scenario:** Same as Use Case 2, but the developer forgets to include `--allow-destructive`.

**CLI Command:**

```bash
/smartspec_data_migration_generator \
  --report .spec/reports/validator/run_124/summary.json \
  --migration-tool liquibase \
  --output-dir db/changelogs \
  --apply
```

**Expected Result:**

1.  Exit Code: `1` (Error).
2.  The workflow immediately fails upon detecting `DROP` operations.
3.  Error message: "ERROR: Destructive operations detected (DROP TABLE legacy_data). Rerun with `--allow-destructive` to proceed."
4.  No migration script is written.

---

## Parameters

### Required Parameters

| Parameter | Description | Supported Values |
| :--- | :--- | :--- |
| `--report <path>` | Path to the `summary.json` file generated by `/smartspec_data_model_validator`. | Valid file path (must exist and be JSON). |
| `--migration-tool <tool>` | Specifies the format and conventions for the generated script. | `flyway`, `liquibase`, `raw-sql` |
| `--output-dir <path>` | The directory where the final migration script will be placed upon successful application. | Valid directory path (must exist). |

### Workflow-Specific Flags (Optional)

| Flag | Description | Default Behavior |
| :--- | :--- | :--- |
| `--allow-destructive` | Permits the generation of DDL statements that involve data loss or schema removal (e.g., `DROP TABLE`, `DROP COLUMN`). **Highly recommended to use with caution.** | Disabled (will hard-fail if destructive operations are required). |

### Universal Flags

| Flag | Description |
| :--- | :--- |
| `--apply` | Executes the governed write scope, writing the migration script to the specified `--output-dir`. Without this, the workflow runs in preview mode. |
| `--config <path>` | Path to the SmartSpec configuration file. |
| `--lang <th|en>` | Output language for reports and messages. |
| `--platform <cli|kilo|ci|other>` | Context of execution. |
| `--out <path>` | Overrides the default report output directory. |
| `--json` | Forces the primary output to be JSON format. |
| `--quiet` | Suppresses non-error console output. |

---

## Output

The workflow produces two main types of output: safe reports and governed artifacts.

### Safe Output Artifacts (Always Generated)

These are written to the safe report path: `.spec/reports/data-migration-generator/<run-id>/`

1.  **`report.md`**: A human-readable report detailing the proposed or generated migration script. This includes the full text of the DDL statements and a summary of operations (e.g., 1 CREATE TABLE, 3 ADD COLUMN).
2.  **`summary.json`**: A structured JSON summary of the run, including the status, scope, count of operations, and the path of the generated script (if applicable).

### Governed Artifacts (Requires `--apply`)

These artifacts are written to the path specified by `--output-dir`.

1.  **Migration Script File**: A single file containing the generated DDL statements, formatted according to the selected `--migration-tool`.
    *   **Flyway Example:** `db/migrations/V20251213103000__my-app.sql`
    *   **Liquibase Example:** `db/changelogs/20251213_my-app.sql` (wrapped in XML/YAML/JSON change log format)
    *   **Raw SQL Example:** `sql/migrations/my-app_migration_20251213.sql`

---

## Notes & Related Workflows

### Security and Review

The generated migration script is a **draft**. It is crucial for the developer to review the script before execution. The workflow cannot handle complex data transformation, default values, or transactional logic that requires manual intervention.

### Related Workflows

*   **`/smartspec_data_model_validator`**: The required prerequisite workflow. Its output (`summary.json`) is the primary input for the migration generator.
*   **`/smartspec_schema_extractor`**: Used to generate the initial schema baseline against which the validator compares the spec.

---
*Last updated: SmartSpec v6