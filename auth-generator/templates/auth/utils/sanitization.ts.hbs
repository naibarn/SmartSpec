/**
 * Input Sanitization Utilities
 * 
 * Prevents XSS, SQL injection, and other injection attacks
 * Generated by SmartSpec Auth Generator
 */

/**
 * Sanitize string input
 * Removes HTML tags and dangerous characters
 */
export function sanitizeString(input: string): string {
  if (typeof input !== 'string') {
    return '';
  }

  return input
    // Remove HTML tags
    .replace(/<[^>]*>/g, '')
    // Remove script tags content
    .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
    // Remove event handlers
    .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '')
    // Remove javascript: protocol
    .replace(/javascript:/gi, '')
    // Trim whitespace
    .trim();
}

/**
 * Sanitize email input
 * Validates and normalizes email addresses
 */
export function sanitizeEmail(email: string): string {
  if (typeof email !== 'string') {
    return '';
  }

  // Remove whitespace and convert to lowercase
  let sanitized = email.trim().toLowerCase();

  // Remove HTML tags
  sanitized = sanitized.replace(/<[^>]*>/g, '');

  // Basic email validation
  const emailRegex = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/;
  if (!emailRegex.test(sanitized)) {
    return '';
  }

  return sanitized;
}

/**
 * Sanitize name input
 * Allows letters, spaces, hyphens, and apostrophes only
 */
export function sanitizeName(name: string): string {
  if (typeof name !== 'string') {
    return '';
  }

  return name
    // Remove HTML tags
    .replace(/<[^>]*>/g, '')
    // Allow only letters, spaces, hyphens, apostrophes
    .replace(/[^a-zA-Z\s\-']/g, '')
    // Remove multiple spaces
    .replace(/\s+/g, ' ')
    // Trim whitespace
    .trim();
}

/**
 * Sanitize URL input
 * Validates and normalizes URLs
 */
export function sanitizeUrl(url: string): string {
  if (typeof url !== 'string') {
    return '';
  }

  // Remove whitespace
  let sanitized = url.trim();

  // Remove HTML tags
  sanitized = sanitized.replace(/<[^>]*>/g, '');

  // Check for dangerous protocols
  const dangerousProtocols = ['javascript:', 'data:', 'vbscript:', 'file:'];
  for (const protocol of dangerousProtocols) {
    if (sanitized.toLowerCase().startsWith(protocol)) {
      return '';
    }
  }

  // Validate URL format
  try {
    const urlObj = new URL(sanitized);
    // Only allow http and https
    if (!['http:', 'https:'].includes(urlObj.protocol)) {
      return '';
    }
    return urlObj.toString();
  } catch {
    return '';
  }
}

/**
 * Sanitize phone number
 * Removes non-numeric characters except + and -
 */
export function sanitizePhone(phone: string): string {
  if (typeof phone !== 'string') {
    return '';
  }

  return phone
    // Remove HTML tags
    .replace(/<[^>]*>/g, '')
    // Allow only numbers, +, -, (, ), and spaces
    .replace(/[^0-9+\-() ]/g, '')
    // Trim whitespace
    .trim();
}

/**
 * Sanitize object recursively
 * Applies appropriate sanitization to all string fields
 */
export function sanitizeObject<T extends Record<string, any>>(
  obj: T,
  fieldRules?: Record<string, 'string' | 'email' | 'name' | 'url' | 'phone'>
): T {
  const sanitized: any = {};

  for (const [key, value] of Object.entries(obj)) {
    if (value === null || value === undefined) {
      sanitized[key] = value;
      continue;
    }

    if (typeof value === 'string') {
      // Apply specific sanitization based on field rules
      const rule = fieldRules?.[key] || 'string';
      switch (rule) {
        case 'email':
          sanitized[key] = sanitizeEmail(value);
          break;
        case 'name':
          sanitized[key] = sanitizeName(value);
          break;
        case 'url':
          sanitized[key] = sanitizeUrl(value);
          break;
        case 'phone':
          sanitized[key] = sanitizePhone(value);
          break;
        default:
          sanitized[key] = sanitizeString(value);
      }
    } else if (Array.isArray(value)) {
      sanitized[key] = value.map(item =>
        typeof item === 'object' && item !== null
          ? sanitizeObject(item, fieldRules)
          : typeof item === 'string'
          ? sanitizeString(item)
          : item
      );
    } else if (typeof value === 'object') {
      sanitized[key] = sanitizeObject(value, fieldRules);
    } else {
      // Numbers, booleans, etc. pass through
      sanitized[key] = value;
    }
  }

  return sanitized as T;
}

/**
 * Escape HTML special characters
 * For displaying user input in HTML
 */
export function escapeHtml(text: string): string {
  if (typeof text !== 'string') {
    return '';
  }

  const htmlEscapeMap: Record<string, string> = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#x27;',
    '/': '&#x2F;',
  };

  return text.replace(/[&<>"'/]/g, char => htmlEscapeMap[char] || char);
}

/**
 * Sanitize SQL input
 * Prevents SQL injection by escaping dangerous characters
 * Note: Use parameterized queries instead when possible
 */
export function sanitizeSql(input: string): string {
  if (typeof input !== 'string') {
    return '';
  }

  return input
    // Escape single quotes
    .replace(/'/g, "''")
    // Remove SQL comments
    .replace(/--/g, '')
    .replace(/\/\*/g, '')
    .replace(/\*\//g, '')
    // Remove semicolons (prevents multiple statements)
    .replace(/;/g, '')
    // Trim whitespace
    .trim();
}

/**
 * Validate and sanitize file name
 * Prevents directory traversal attacks
 */
export function sanitizeFileName(fileName: string): string {
  if (typeof fileName !== 'string') {
    return '';
  }

  return fileName
    // Remove HTML tags
    .replace(/<[^>]*>/g, '')
    // Remove path traversal attempts
    .replace(/\.\./g, '')
    .replace(/\//g, '')
    .replace(/\\/g, '')
    // Remove dangerous characters
    .replace(/[<>:"|?*\x00-\x1f]/g, '')
    // Trim whitespace
    .trim();
}

/**
 * Sanitize search query
 * Prevents search injection attacks
 */
export function sanitizeSearchQuery(query: string): string {
  if (typeof query !== 'string') {
    return '';
  }

  return query
    // Remove HTML tags
    .replace(/<[^>]*>/g, '')
    // Remove special regex characters
    .replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    // Trim whitespace
    .trim()
    // Limit length
    .substring(0, 200);
}

/**
 * Sanitization middleware for Express
 * Automatically sanitizes request body, query, and params
 */
export function sanitizationMiddleware(
  fieldRules?: Record<string, 'string' | 'email' | 'name' | 'url' | 'phone'>
) {
  return (req: any, _res: any, next: any) => {
    // Sanitize body
    if (req.body && typeof req.body === 'object') {
      req.body = sanitizeObject(req.body, fieldRules);
    }

    // Sanitize query params
    if (req.query && typeof req.query === 'object') {
      req.query = sanitizeObject(req.query, fieldRules);
    }

    // Sanitize URL params
    if (req.params && typeof req.params === 'object') {
      req.params = sanitizeObject(req.params, fieldRules);
    }

    next();
  };
}

/**
 * Field-specific sanitization rules for auth endpoints
 */
export const authFieldRules = {
  email: 'email' as const,
  name: 'name' as const,
  firstName: 'name' as const,
  lastName: 'name' as const,
  phone: 'phone' as const,
  website: 'url' as const,
  avatar: 'url' as const,
};

/**
 * Pre-configured sanitization middleware for auth
 */
export const authSanitizationMiddleware = sanitizationMiddleware(authFieldRules);
