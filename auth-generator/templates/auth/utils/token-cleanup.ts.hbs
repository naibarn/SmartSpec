/**
 * Token Cleanup Utility
 * 
 * Cleans up expired tokens from database
 * Generated by SmartSpec Auth Generator
 */

import { UserRepository } from '../repositories/user.repository.interface';

export class TokenCleanupService {
  private userRepository: UserRepository;
  private cleanupInterval: NodeJS.Timeout | null = null;

  constructor(userRepository: UserRepository) {
    this.userRepository = userRepository;
  }

  /**
   * Clean up expired tokens
   */
  async cleanupExpiredTokens(): Promise<{
    emailVerificationTokens: number;
    passwordResetTokens: number;
  }> {
    const now = new Date();
    let emailVerificationTokens = 0;
    let passwordResetTokens = 0;

    try {
      // Get all users with tokens
      const users = await this.userRepository.findAll();

      for (const user of users) {
        let needsUpdate = false;
        const updates: any = {};

        {{#if features.emailVerification}}
        // Clean up expired email verification tokens
        if (
          user.emailVerificationToken &&
          user.emailVerificationExpires &&
          new Date(user.emailVerificationExpires) < now
        ) {
          updates.emailVerificationToken = undefined;
          updates.emailVerificationExpires = undefined;
          emailVerificationTokens++;
          needsUpdate = true;
        }
        {{/if}}

        {{#if features.passwordReset}}
        // Clean up expired password reset tokens
        if (
          user.resetPasswordToken &&
          user.resetPasswordExpires &&
          new Date(user.resetPasswordExpires) < now
        ) {
          updates.resetPasswordToken = undefined;
          updates.resetPasswordExpires = undefined;
          passwordResetTokens++;
          needsUpdate = true;
        }
        {{/if}}

        {{#if features.accountLockout}}
        // Unlock accounts with expired lockout
        if (
          user.lockedUntil &&
          new Date(user.lockedUntil) < now
        ) {
          updates.lockedUntil = undefined;
          updates.loginAttempts = 0;
          needsUpdate = true;
        }
        {{/if}}

        if (needsUpdate) {
          await this.userRepository.update(user.id, updates);
        }
      }

      return {
        emailVerificationTokens,
        passwordResetTokens,
      };
    } catch (error) {
      console.error('Token cleanup failed:', error);
      throw error;
    }
  }

  /**
   * Start automatic cleanup (runs every hour)
   */
  startAutomaticCleanup(intervalMs: number = 60 * 60 * 1000): void {
    if (this.cleanupInterval) {
      console.warn('Cleanup already running');
      return;
    }

    console.log(`Starting token cleanup (interval: ${intervalMs}ms)`);

    // Run immediately
    this.cleanupExpiredTokens()
      .then((result) => {
        console.log('Initial token cleanup completed:', result);
      })
      .catch((error) => {
        console.error('Initial token cleanup failed:', error);
      });

    // Then run periodically
    this.cleanupInterval = setInterval(async () => {
      try {
        const result = await this.cleanupExpiredTokens();
        console.log('Token cleanup completed:', result);
      } catch (error) {
        console.error('Token cleanup failed:', error);
      }
    }, intervalMs);
  }

  /**
   * Stop automatic cleanup
   */
  stopAutomaticCleanup(): void {
    if (this.cleanupInterval) {
      clearInterval(this.cleanupInterval);
      this.cleanupInterval = null;
      console.log('Token cleanup stopped');
    }
  }
}
